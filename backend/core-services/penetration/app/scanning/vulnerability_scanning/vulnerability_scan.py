# core/scanning/vulnerability_scanning/vulnerability_scan.py
import time
from concurrent.futures import ThreadPoolExecutor, as_completed

# Attempt to import checks from common_vulnerabilities. The module can be
# executed as part of the package or standalone, so try both import styles.
try:  # pragma: no cover - import resolution depends on context
    from .common_vulnerabilities import ALL_CHECKS
except ImportError:  # pragma: no cover
    try:
        from common_vulnerabilities import ALL_CHECKS
    except ImportError:  # pragma: no cover
        ALL_CHECKS = []
        print(
            "CRITICAL: Could not import ALL_CHECKS from common_vulnerabilities.py. "
            "Vulnerability scanning will be empty."
        )


DEFAULT_SCAN_THREADS = 5

class VulnerabilityScanner:
    def __init__(self, num_threads=DEFAULT_SCAN_THREADS):
        self.num_threads = num_threads
        self.vulnerability_checks = ALL_CHECKS # Load all defined checks

    def scan_target_service(self, target_ip, port, service_info):
        """
        Runs all applicable vulnerability checks against a single service on a target.

        Args:
            target_ip (str): The IP address of the target.
            port (int): The port number of the service.
            service_info (dict): Information about the service running on the port.
                                 Expected keys: 'protocol' (tcp/udp), 'service_name', 'version', 'banner'.
                                 This comes from the service enumerator.

        Returns:
            list: A list of vulnerability result dictionaries found for this service. Empty if none.
        """
        found_vulnerabilities = []
        # print(f"  Scanning {target_ip}:{port} ({service_info.get('service_name', 'unknown')})...")

        for check_function in self.vulnerability_checks:
            try:
                # Pass necessary info to the check function.
                # Some checks might only need ip/port, others might use service_info.
                vulnerability = check_function(target_ip, port, service_info=service_info)

                if vulnerability:
                    if isinstance(vulnerability, list): # Some checks might return a list of vulns
                        for vuln_item in vulnerability:
                            if isinstance(vuln_item, dict) and vuln_item.get("name"): # Ensure it's a valid vuln dict
                                vuln_item["port"] = port # Add port context
                                vuln_item["protocol"] = service_info.get("protocol", "tcp") # Assume tcp if not specified
                                found_vulnerabilities.append(vuln_item)
                    elif isinstance(vulnerability, dict) and vulnerability.get("name"): # Single vuln dict
                        vulnerability["port"] = port
                        vulnerability["protocol"] = service_info.get("protocol", "tcp")
                        found_vulnerabilities.append(vulnerability)

            except Exception as e:
                # print(f"    Error running check {check_function.__name__} on {target_ip}:{port}: {e}")
                found_vulnerabilities.append({
                    "name": f"Check Error: {check_function.__name__}",
                    "severity": "Info",
                    "description": f"The vulnerability check itself failed: {e}",
                    "port": port,
                    "protocol": service_info.get("protocol", "tcp"),
                    "evidence": "Scanner internal error"
                })
        return found_vulnerabilities

    def scan_target(self, target_ip, services_data):
        """
        Performs vulnerability scanning on all specified services for a single target IP.

        Args:
            target_ip (str): The IP address of the target.
            services_data (dict): A dictionary where keys are port numbers (int) and
                                  values are dictionaries of service information from the
                                  service enumerator (e.g., output of enumerate_services).
                                  Example: {
                                      21: {'protocol': 'tcp', 'status': 'open', 'banner': '...', 'service_name': 'ftp', ...},
                                      80: {'protocol': 'tcp', 'status': 'open', 'banner': '...', 'service_name': 'http', ...}
                                  }
        Returns:
            dict: Results of the vulnerability scan for the target.
                  {"target_ip": ip, "vulnerabilities": list_of_vuln_dicts, "errors": list_of_errors}
        """
        if not self.vulnerability_checks:
            return {
                "target_ip": target_ip,
                "vulnerabilities": [],
                "errors": ["No vulnerability checks loaded/defined."]
            }

        all_found_vulnerabilities = []
        errors = []

        # print(f"\nStarting vulnerability scan for {target_ip}...")

        with ThreadPoolExecutor(max_workers=self.num_threads) as executor:
            future_to_service = {}
            for port, service_info in services_data.items():
                if service_info.get("status") == "open": # Only scan open ports
                    future = executor.submit(self.scan_target_service, target_ip, port, service_info)
                    future_to_service[future] = (port, service_info.get('service_name', 'unknown'))
                else:
                    # print(f"  Skipping port {port} as it's not marked 'open' (status: {service_info.get('status')})")
                    pass

            for future in as_completed(future_to_service):
                port_info = future_to_service[future]
                try:
                    vulnerabilities_on_service = future.result()
                    if vulnerabilities_on_service:
                        all_found_vulnerabilities.extend(vulnerabilities_on_service)
                except Exception as e:
                    # print(f"  Major error processing service {port_info[1]} on port {port_info[0]}: {e}")
                    errors.append(f"Error scanning port {port_info[0]} ({port_info[1]}): {e}")

        # print(f"Vulnerability scan finished for {target_ip}.")
        return {
            "target_ip": target_ip,
            "vulnerabilities": all_found_vulnerabilities,
            "errors": errors
        }


if __name__ == "__main__":
    import socket # Moved import here for the example usage only
    scanner = VulnerabilityScanner(num_threads=3)

    # --- Test Case 1: Localhost with some services ---
    # Prerequisite: Run some services locally for testing.
    # e.g., Python HTTP server: `python -m http.server 7000`
    # e.g., vsftpd docker: `docker run -d -p 2100:21 -e FTP_USER_PASS=test -e FTP_USER_NAME=testuser fauria/vsftpd` (for non-anonymous)
    # For anonymous FTP test: `docker run -d -p 2121:21 -p 2020:20 -e ANONYMOUS_ENABLE=YES stilliard/pure-ftpd`

    target_localhost = "127.0.0.1"
    # Simulated output from a service enumerator for localhost
    localhost_services = {
        2121: {"protocol": "tcp", "status": "open", "service_name": "ftp", "banner": "Pure-FTPd server ready"},
        7000: {"protocol": "tcp", "status": "open", "service_name": "http", "banner": "SimpleHTTP/0.6 Python/3.9.12",
               "version": "0.6", "comment": "Python 3.9.12"}, # Added more details for http check
        22: {"protocol": "tcp", "status": "open", "service_name": "ssh", "banner": "SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.5"},
        12345: {"protocol": "tcp", "status": "closed"} # A closed port
    }

    print(f"--- Testing Vulnerability Scanner against {target_localhost} ---")
    results_localhost = scanner.scan_target(target_localhost, localhost_services)

    print(f"\nScan Results for {results_localhost['target_ip']}:")
    if results_localhost["vulnerabilities"]:
        print("  Vulnerabilities Found:")
        for vuln in results_localhost["vulnerabilities"]:
            print(f"    - Name: {vuln['name']} (Port: {vuln['port']}/{vuln['protocol']})")
            print(f"      Severity: {vuln['severity']}")
            print(f"      Description: {vuln['description']}")
            print(f"      Evidence: {str(vuln.get('evidence','N/A'))[:100]}") # Truncate long evidence
    else:
        print("  No vulnerabilities found.")
    if results_localhost["errors"]:
        print("  Errors during scan:")
        for err in results_localhost["errors"]:
            print(f"    - {err}")

    # --- Test Case 2: Scanme.nmap.org (public test site) ---
    # Note: Results can vary as scanme.nmap.org might change.
    target_scanme = "scanme.nmap.org"
    # Simulated service data for scanme.nmap.org (usually has FTP on 21, SSH on 22, HTTP on 80)
    scanme_services = {
        21: {"protocol": "tcp", "status": "open", "service_name": "ftp", "banner": "vsFTPd 3.0.3"}, # Assuming FTP is open
        22: {"protocol": "tcp", "status": "open", "service_name": "ssh", "banner": "SSH-2.0-OpenSSH_6.6.1p1 Ubuntu-2ubuntu2.13"},
        80: {"protocol": "tcp", "status": "open", "service_name": "http", "banner": "Apache/2.4.7 (Ubuntu)"},
    }
    # Check if scanme.nmap.org is resolvable before trying to scan
    try:
        socket.gethostbyname(target_scanme)
        print(f"\n--- Testing Vulnerability Scanner against {target_scanme} ---")
        results_scanme = scanner.scan_target(target_scanme, scanme_services)
        print(f"\nScan Results for {results_scanme['target_ip']}:")
        if results_scanme["vulnerabilities"]:
            print("  Vulnerabilities Found:")
            for vuln in results_scanme["vulnerabilities"]:
                print(f"    - Name: {vuln['name']} (Port: {vuln['port']}/{vuln['protocol']})")
                print(f"      Severity: {vuln['severity']}")
                # print(f"      Description: {vuln['description']}")
                print(f"      Evidence: {str(vuln.get('evidence','N/A'))[:100]}")
        else:
            print("  No vulnerabilities found.")
        if results_scanme["errors"]:
            print("  Errors during scan:")
            for err in results_scanme["errors"]:
                print(f"    - {err}")
    except socket.gaierror:
        print(f"\n--- Skipping test for {target_scanme}: Could not resolve hostname. ---")


    print("\n--- Vulnerability Scanner Test Finished ---")
