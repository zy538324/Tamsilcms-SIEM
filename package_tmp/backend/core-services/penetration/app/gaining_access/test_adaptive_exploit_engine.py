import unittest
from unittest.mock import MagicMock, patch
from core.gaining_access.adaptive_exploit_engine import generate_adaptive_exploit
from conversational_ai import ConversationalAI

class TestAdaptiveExploitEngine(unittest.TestCase):

    def test_generate_adaptive_exploit(self):
        # Mock the conversational AI
        conversational_ai = ConversationalAI()
        conversational_ai.add_message_to_queue = MagicMock()

        # Mock the PentestAI
        pentest_ai_mock = MagicMock()
        pentest_ai_mock.analyze_target.return_value = {
            'phase': 'gaining_access',
            'recommended_actions': ['Exploit identified vulnerabilities']
        }

        # Mock the execute_exploit function
        execute_exploit_mock = MagicMock()
        execute_exploit_mock.return_value = {
            'status': 'success',
            'output': 'Exploit executed successfully'
        }

        # Patch the PentestAI and execute_exploit functions
        with patch('core.gaining_access.adaptive_exploit_engine.PentestAI', return_value=pentest_ai_mock):
            with patch('core.gaining_access.adaptive_exploit_engine.execute_exploit', return_value=execute_exploit_mock):
                # Define the test data
                target = '127.0.0.1'
                vulnerability_data = {
                    'vulnerabilities': [
                        {
                            'name': 'Test Vulnerability',
                            'port': 80,
                            'severity': 'High',
                            'description': 'A test vulnerability',
                            'evidence': 'Test evidence'
                        }
                    ]
                }
                open_ports = {80: {'service_guess': 'http'}}

                # Run the function
                results = generate_adaptive_exploit(target, vulnerability_data, open_ports, conversational_ai=conversational_ai)

                # Assert the results
                self.assertIn('adaptive_exploits', results)
                self.assertEqual(len(results['adaptive_exploits']), 1)
                self.assertEqual(results['adaptive_exploits'][0]['status'], 'success')
                self.assertEqual(results['adaptive_exploits'][0]['execution_output'], 'Exploit executed successfully')

if __name__ == '__main__':
    unittest.main()
