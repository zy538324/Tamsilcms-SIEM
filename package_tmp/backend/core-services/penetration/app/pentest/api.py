from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from . import db, models, schemas
from core_services.common.escalation import EscalationClient
import requests

router = APIRouter()

def get_db():
    s = db.SessionLocal()
    try:
        yield s
    finally:
        s.close()

@router.post("/engagements")
def create_engagement(e: schemas.EngagementCreate, session: Session = Depends(get_db)):
    eng = models.PentestEngagement(
        organisation_id=e.organisation_id,
        name=e.name,
        engagement_type=e.engagement_type,
    )
    session.add(eng)
    session.commit()
    session.refresh(eng)
    return {"id": eng.id}

@router.post("/findings")
def create_finding(f: schemas.FindingCreate, session: Session = Depends(get_db)):
    finding = models.PentestFinding(
        engagement_id=f.engagement_id,
        asset_id=f.asset_id,
        finding_type=f.finding_type,
        title=f.title,
        description=f.description,
        severity=str(f.severity),
        confidence=str(f.confidence),
        exploit_proven=f.exploit_proven,
    )
    session.add(finding)
    session.commit()
    session.refresh(finding)
    return {"id": finding.id}

@router.post("/findings/{finding_id}/evidence")
def add_evidence(finding_id: str, ev: schemas.EvidenceCreate, session: Session = Depends(get_db)):
    finding = session.query(models.PentestFinding).filter(models.PentestFinding.id == finding_id).first()
    if not finding:
        raise HTTPException(status_code=404, detail="Finding not found")
    pe = models.PentestEvidence(
        finding_id=finding_id,
        evidence_type=ev.evidence_type,
        storage_uri=ev.storage_uri,
        hash=ev.hash,
    )
    session.add(pe)
    session.commit()
    session.refresh(pe)
    return {"id": pe.id}

@router.post("/findings/{finding_id}/escalate")
def escalate_finding(finding_id: str, session: Session = Depends(get_db)):
    finding = session.query(models.PentestFinding).filter(models.PentestFinding.id == finding_id).first()
    if not finding:
        raise HTTPException(status_code=404, detail="Finding not found")

    # create PSA case
    client = EscalationClient()
    try:
        # organisation resolution should come from engagement -> organisation_id
        eng = session.query(models.PentestEngagement).filter(models.PentestEngagement.id == finding.engagement_id).first()
        org_id = eng.organisation_id if eng else ""
        resp = client.create_case(organisation_id=org_id or "", case_type="penetration", source_system="pentest", severity=int(finding.severity) if finding.severity else 1)
        psa_case = resp.get("id") or resp
        # record mapping
        pc = models.PentestCase(finding_id=finding.id, psa_case_id=psa_case)
        session.add(pc)
        session.commit()

        # attach evidence packages to PSA if any
        evs = session.query(models.PentestEvidence).filter(models.PentestEvidence.finding_id == finding.id).all()
        for e in evs:
            try:
                url = f"{client.base}/psa/cases/{psa_case}/evidence"
                payload = {"evidence_type": e.evidence_type, "source_system": "pentest", "stored_uri": e.storage_uri, "hash": e.hash}
                requests.post(url, json=payload, timeout=10)
            except Exception:
                pass

        # record in shared escalations table
        session.execute("INSERT INTO escalations (source_service, source_id, organisation_id, psa_case_id, status) VALUES ($1,$2,$3,$4,$5)", ("pentest", finding.id, org_id or None, psa_case, "escalated"))
        session.commit()

        return {"psa_case_id": psa_case}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
