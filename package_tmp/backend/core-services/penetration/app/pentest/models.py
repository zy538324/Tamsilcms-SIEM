import uuid
from datetime import datetime
from sqlalchemy import Column, String, DateTime, Text, Boolean, ForeignKey, Integer
from sqlalchemy.dialects.postgresql import JSONB
from sqlalchemy.orm import relationship
from .db import Base

def gen_uuid():
    return str(uuid.uuid4())

class PentestEngagement(Base):
    __tablename__ = "pentest_engagements"
    id = Column(String(36), primary_key=True, default=gen_uuid)
    organisation_id = Column(String(36), ForeignKey("organisations.id"))
    name = Column(Text)
    engagement_type = Column(Text)
    start_date = Column(DateTime)
    end_date = Column(DateTime)
    status = Column(Text, default="planned")
    authorised_by = Column(String(36))

class PentestScope(Base):
    __tablename__ = "pentest_scope"
    id = Column(String(36), primary_key=True, default=gen_uuid)
    engagement_id = Column(String(36), ForeignKey("pentest_engagements.id"))
    asset_id = Column(String(36), ForeignKey("assets.id"))
    scope_type = Column(Text)
    notes = Column(Text)

class AttackSurface(Base):
    __tablename__ = "attack_surfaces"
    id = Column(String(36), primary_key=True, default=gen_uuid)
    engagement_id = Column(String(36), ForeignKey("pentest_engagements.id"))
    surface_type = Column(Text)
    description = Column(Text)
    discovered_at = Column(DateTime, default=datetime.utcnow)

class AttackTechnique(Base):
    __tablename__ = "attack_techniques"
    id = Column(String(36), primary_key=True, default=gen_uuid)
    technique_id = Column(Text)
    name = Column(Text)
    category = Column(Text)

class PentestTool(Base):
    __tablename__ = "pentest_tools"
    id = Column(String(36), primary_key=True, default=gen_uuid)
    name = Column(Text)
    version = Column(Text)
    tool_type = Column(Text)

class PentestToolRun(Base):
    __tablename__ = "pentest_tool_runs"
    id = Column(String(36), primary_key=True, default=gen_uuid)
    engagement_id = Column(String(36), ForeignKey("pentest_engagements.id"))
    tool_id = Column(String(36), ForeignKey("pentest_tools.id"))
    started_at = Column(DateTime)
    completed_at = Column(DateTime)
    status = Column(Text)
    raw_output_uri = Column(Text)

class PentestFinding(Base):
    __tablename__ = "pentest_findings"
    id = Column(String(36), primary_key=True, default=gen_uuid)
    engagement_id = Column(String(36), ForeignKey("pentest_engagements.id"))
    asset_id = Column(String(36), ForeignKey("assets.id"))
    finding_type = Column(Text)
    title = Column(Text)
    description = Column(Text)
    severity = Column(String(10))
    confidence = Column(String(10))
    exploit_proven = Column(Boolean, default=False)
    discovered_at = Column(DateTime, default=datetime.utcnow)

class FindingVulnerability(Base):
    __tablename__ = "finding_vulnerabilities"
    finding_id = Column(String(36), ForeignKey("pentest_findings.id"), primary_key=True)
    vulnerability_id = Column(String(36), primary_key=True)

class AttackChain(Base):
    __tablename__ = "attack_chains"
    id = Column(String(36), primary_key=True, default=gen_uuid)
    engagement_id = Column(String(36), ForeignKey("pentest_engagements.id"))
    description = Column(Text)
    impact = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)

class AttackChainStep(Base):
    __tablename__ = "attack_chain_steps"
    chain_id = Column(String(36), ForeignKey("attack_chains.id"), primary_key=True)
    step_order = Column(Integer, primary_key=True)
    technique_id = Column(Text)
    finding_id = Column(String(36), ForeignKey("pentest_findings.id"))
    notes = Column(Text)

class PentestEvidence(Base):
    __tablename__ = "pentest_evidence"
    id = Column(String(36), primary_key=True, default=gen_uuid)
    finding_id = Column(String(36), ForeignKey("pentest_findings.id"))
    evidence_type = Column(Text)
    storage_uri = Column(Text)
    hash = Column(Text)
    captured_at = Column(DateTime, default=datetime.utcnow)

class PentestCase(Base):
    __tablename__ = "pentest_cases"
    finding_id = Column(String(36), ForeignKey("pentest_findings.id"), primary_key=True)
    psa_case_id = Column(String(36))
    created_at = Column(DateTime, default=datetime.utcnow)
