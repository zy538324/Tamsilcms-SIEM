import json
import re
import logging
import requests
from logging_config import get_logger
logger = get_logger(__name__)

# Configure logging

# Paths to the vulnerability databases
NVD_DB_PATH = "nvd.json"
REMEDIATION_DB_PATH = "remediation_db.json"

def load_nvd_db():
    """
    Load the NVD vulnerability database from a JSON file.
    
    Returns:
        dict: A dictionary mapping CVE IDs to vulnerability details.
    """
    try:
        with open(NVD_DB_PATH, "r") as f:
            nvd_db = {entry["id"]: entry for entry in json.load(f)}
        return nvd_db
    except Exception as e:
        logging.error(f"Error loading NVD database: {e}")
        return {}

def load_remediation_db():
    """
    Load the remediation database from a JSON file.
    
    Returns:
        dict: A dictionary mapping CVE IDs to remediation details.
    """
    try:
        with open(REMEDIATION_DB_PATH, "r") as f:
            remediation_db = json.load(f)
        return remediation_db
    except Exception as e:
        logging.error(f"Error loading remediation database: {e}")
        return {}

def fetch_remediation_data(cve_id):
    """
    Fetch remediation data for a given CVE ID from external sources.
    
    Args:
        cve_id (str): The CVE ID to look up.
    
    Returns:
        dict: Remediation details, if available.
    """
    remediation_data = {}
    try:
        # Example: Fetch remediation data from GitHub Advisory Database
        github_url = f"https://api.github.com/advisories?cve_id={cve_id}"
        response = requests.get(github_url)
        if response.status_code == 200:
            advisories = response.json()
            if advisories:
                remediation_data = {
                    "patch": advisories[0].get("patched_versions", "No patch information available."),
                    "workaround": advisories[0].get("summary", "No workaround available."),
                    "references": [ref["url"] for ref in advisories[0].get("references", [])]
                }
    except Exception as e:
        logging.warning(f"Failed to fetch remediation data for {cve_id}: {e}")
    return remediation_data

def enrich_vulnerability_data(nvd_db, remediation_db):
    """
    Enrich the NVD database with remediation data.
    
    Args:
        nvd_db (dict): The NVD vulnerability database.
        remediation_db (dict): The remediation database.
    
    Returns:
        dict: An enriched vulnerability database.
    """
    enriched_db = {}
    for cve_id, entry in nvd_db.items():
        remediation = remediation_db.get(cve_id, {})
        if not remediation:
            remediation = fetch_remediation_data(cve_id)
        
        enriched_db[cve_id] = {
            "title": entry.get("title"),
            "description": entry.get("description"),
            "url": entry.get("url"),
            "remediation": remediation
        }
    return enriched_db

def scan_vulnerabilities(services):
    """
    Check for known vulnerabilities based on service banners.
    
    Args:
        services (dict): A dictionary mapping ports to service banners.
    
    Returns:
        dict: A dictionary mapping ports to potential vulnerabilities.
    """
    vulnerabilities = {}
    try:
        # Load the NVD and remediation databases
        nvd_db = load_nvd_db()
        remediation_db = load_remediation_db()
        enriched_db = enrich_vulnerability_data(nvd_db, remediation_db)
        
        for port, banner in services.items():
            found_vulnerability = False
            for cve_id, entry in enriched_db.items():
                description = entry["description"]
                if re.search(re.escape(banner), description, re.IGNORECASE):
                    vulnerabilities[port] = {
                        "cve_id": cve_id,
                        "title": entry["title"],
                        "description": description,
                        "url": entry["url"],
                        "remediation": entry["remediation"]
                    }
                    logging.info(f"Vulnerability detected on port {port}: {cve_id}")
                    found_vulnerability = True
                    break
            
            if not found_vulnerability:
                vulnerabilities[port] = {
                    "cve_id": None,
                    "title": "No known vulnerabilities.",
                    "description": "No matching vulnerabilities found in the database.",
                    "url": None,
                    "remediation": {}
                }
                logging.info(f"No vulnerabilities detected on port {port}.")
    
    except Exception as e:
        logging.error(f"Error during vulnerability scanning: {e}")
        return {"error": f"Error during vulnerability scanning: {e}"}
    
    return {"vulnerabilities": vulnerabilities}

# Example usage
if __name__ == "__main__":
    # Example service banners
    services = {
        22: "SSH-2.0-OpenSSH_7.6p1 Ubuntu-4ubuntu0.3",
        80: "Apache/2.4.29 (Ubuntu)",
        3306: "MySQL 5.5.62",
        21: "vsftpd 2.3.4",
        8080: "nginx/1.12.2"
    }
    
    result = scan_vulnerabilities(services)
    for port, vuln in result["vulnerabilities"].items():
        logger.info(f"Port {port}:")
        logger.info(f"  CVE ID: {vuln['cve_id']}")
        logger.info(f"  Title: {vuln['title']}")
        logger.info(f"  Description: {vuln['description']}")
        logger.info(f"  URL: {vuln['url']}")
        logger.info(f"  Remediation: {vuln['remediation']}")
