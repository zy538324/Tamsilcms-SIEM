"""Failure mode tests for MVP-10 vulnerability intelligence engine."""
from __future__ import annotations

import unittest
from datetime import datetime, timezone
from uuid import uuid4

from app.engine import build_vulnerability_records
from app.lifecycle import can_transition
from app.models import (
    AssetMetadata,
    BehaviouralSignal,
    CveFeedStatus,
    DetectionBatch,
    NetworkExposure,
    PatchState,
    SoftwareComponent,
    VulnerabilityMatch,
)


def build_base_batch(
    *,
    running: bool = True,
    detection_confidence: float = 0.9,
    behavioural_signals: list[BehaviouralSignal] | None = None,
    patches: list[PatchState] | None = None,
    cve_feeds: list[CveFeedStatus] | None = None,
    exposure_state: str = "reachable",
) -> DetectionBatch:
    """Create a baseline detection batch for testing."""
    now = datetime.now(timezone.utc)
    return DetectionBatch(
        detection_id=uuid4(),
        asset=AssetMetadata(
            tenant_id="tenant-001",
            asset_id="asset-001",
            criticality="high",
            role="database",
            environment="production",
        ),
        detected_at=now,
        inventory=[
            SoftwareComponent(
                name="nginx",
                version="1.0.0",
                vendor="ExampleCorp",
                running=running,
            )
        ],
        patches=patches or [],
        exposures=[
            NetworkExposure(
                service="nginx",
                port=443,
                protocol="tcp",
                reachability="external",
                state=exposure_state,
                authenticated=False,
            )
        ],
        behavioural_signals=behavioural_signals or [],
        compensating_controls=[],
        vulnerability_matches=[
            VulnerabilityMatch(
                cve_id="CVE-2024-0001",
                component="nginx",
                installed_version="1.0.0",
                fixed_version="1.0.1",
                detection_confidence=detection_confidence,
                detection_notes="Automated mapping.",
            )
        ],
        exposure_weaknesses=[],
        cve_feeds=cve_feeds or [],
        detection_source="unit-test",
    )


class FailureModeTests(unittest.TestCase):
    """Validate failure-mode handling with conservative escalation."""

    def test_feed_error_reduces_confidence(self) -> None:
        batch = build_base_batch(
            cve_feeds=[
                CveFeedStatus(
                    source="nvd",
                    status="error",
                    last_updated=datetime.now(timezone.utc),
                    details="timeout",
                )
            ]
        )
        record = build_vulnerability_records(batch)[0]
        self.assertLess(record.risk_score.confidence, 0.9)

    def test_false_version_match_marks_ambiguity(self) -> None:
        batch = build_base_batch(detection_confidence=0.2)
        record = build_vulnerability_records(batch)[0]
        self.assertIn("detection=ambiguous", record.risk_score.contributors)

    def test_superseded_patch_flagged(self) -> None:
        batch = build_base_batch(
            patches=[
                PatchState(
                    component=None,
                    patch_id="PATCH-001",
                    status="superseded",
                    detected_at=datetime.now(timezone.utc),
                )
            ]
        )
        record = build_vulnerability_records(batch)[0]
        self.assertIn("patch=superseded", record.risk_score.contributors)

    def test_disabled_service_does_not_escalate(self) -> None:
        batch = build_base_batch(running=False, exposure_state="unreachable")
        record = build_vulnerability_records(batch)[0]
        self.assertEqual(record.severity, "info")

    def test_behaviour_contradiction_reduces_risk(self) -> None:
        base = build_vulnerability_records(build_base_batch())[0]
        batch = build_base_batch(
            behavioural_signals=[
                BehaviouralSignal(
                    signal_id="sig-001",
                    summary="Exploit attempt not observed.",
                    observed_at=datetime.now(timezone.utc),
                    confidence=0.8,
                    direction="contradicts",
                )
            ]
        )
        contradicted = build_vulnerability_records(batch)[0]
        self.assertIn("behaviour=contradicted", contradicted.risk_score.contributors)
        self.assertLess(contradicted.risk_score.score, base.risk_score.score)

    def test_mixed_behaviour_defaults_to_contradicted(self) -> None:
        batch = build_base_batch(
            behavioural_signals=[
                BehaviouralSignal(
                    signal_id="sig-002",
                    summary="Exploit attempt observed.",
                    observed_at=datetime.now(timezone.utc),
                    confidence=0.8,
                    direction="supports",
                ),
                BehaviouralSignal(
                    signal_id="sig-003",
                    summary="Exploit attempt refuted.",
                    observed_at=datetime.now(timezone.utc),
                    confidence=0.8,
                    direction="contradicts",
                ),
            ]
        )
        record = build_vulnerability_records(batch)[0]
        self.assertEqual(record.exposure_profile.behavioural_context, "contradicted")
        self.assertFalse(record.exposure_profile.observed_behaviour)

    def test_risk_acceptance_abuse_prevented(self) -> None:
        self.assertFalse(can_transition("accepted", "accepted"))


if __name__ == "__main__":
    unittest.main()
