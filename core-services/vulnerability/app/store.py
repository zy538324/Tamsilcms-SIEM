"""In-memory stores for vulnerability intelligence."""
from __future__ import annotations

from collections import deque
from typing import Deque, Optional
from uuid import UUID

from .models import DetectionBatch, RiskAcceptanceRecord, VulnerabilityRecord


class DetectionStore:
    """Store incoming detection batches."""

    def __init__(self, max_items: int) -> None:
        self._items: Deque[DetectionBatch] = deque(maxlen=max_items)

    def add(self, batch: DetectionBatch) -> None:
        self._items.appendleft(batch)

    def list(self) -> list[DetectionBatch]:
        return list(self._items)


class VulnerabilityStore:
    """Store vulnerability records with lookup by ID."""

    def __init__(self) -> None:
        self._items: dict[UUID, VulnerabilityRecord] = {}

    def add(self, record: VulnerabilityRecord) -> None:
        self._items[record.vulnerability_id] = record

    def list(self) -> list[VulnerabilityRecord]:
        return list(self._items.values())

    def get(self, vulnerability_id: UUID) -> Optional[VulnerabilityRecord]:
        return self._items.get(vulnerability_id)

    def update(self, vulnerability_id: UUID, record: VulnerabilityRecord) -> None:
        self._items[vulnerability_id] = record


class StoreBundle:
    """Container for all stores."""

    def __init__(self, max_detections: int) -> None:
        self.detections = DetectionStore(max_detections)
        self.vulnerabilities = VulnerabilityStore()
        self.acceptances: dict[UUID, list[RiskAcceptanceRecord]] = {}


store: Optional[StoreBundle] = None


def init_store(max_detections: int) -> None:
    """Initialise the store bundle."""
    global store
    store = StoreBundle(max_detections)
