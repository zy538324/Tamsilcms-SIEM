from typing import Optional
from sqlalchemy import Column, String, DateTime, func, JSON, text
from sqlalchemy.dialects.postgresql import UUID as PGUUID, JSONB
from sqlalchemy import select
from uuid import UUID
from .db import SessionLocal, engine, Base
from datetime import datetime


class VulnerabilityRecordTable(Base):
    __tablename__ = "vulnerability_records"
    id = Column(PGUUID(as_uuid=True), primary_key=True)
    payload = Column(JSONB, nullable=False)
    recorded_at = Column(DateTime(timezone=True), server_default=func.now())


def init_sql_store():
    # Create a lightweight table for JSONB-stored vulnerability records
    with engine.begin() as conn:
        conn.execute(
            text(
                """
            CREATE TABLE IF NOT EXISTS vulnerability_records (
                id UUID PRIMARY KEY,
                payload JSONB NOT NULL,
                recorded_at TIMESTAMPTZ NOT NULL DEFAULT now()
            );
            """
            )
        )


class SQLVulnerabilityStore:
    def __init__(self):
        self.Session = SessionLocal

    def add(self, record):
        payload = record.model_dump() if hasattr(record, "model_dump") else record.dict()
        vid = str(record.vulnerability_id)
        stmt = text("INSERT INTO vulnerability_records (id, payload, recorded_at) VALUES (:id, :payload, now())")
        with self.Session() as s:
            s.execute(stmt, {"id": vid, "payload": payload})
            s.commit()

    def list(self):
        with self.Session() as s:
            res = s.execute(text("SELECT id, payload FROM vulnerability_records"))
            return [r[1] for r in res.fetchall()]

    def get(self, vulnerability_id: UUID):
        with self.Session() as s:
            r = s.execute(text("SELECT payload FROM vulnerability_records WHERE id = :id"), {"id": str(vulnerability_id)}).fetchone()
            return r[0] if r else None

    def update(self, vulnerability_id: UUID, record):
        payload = record.model_dump() if hasattr(record, "model_dump") else record.dict()
        stmt = text("UPDATE vulnerability_records SET payload = :payload WHERE id = :id")
        with self.Session() as s:
            s.execute(stmt, {"id": str(vulnerability_id), "payload": payload})
            s.commit()
