from typing import Optional
from sqlalchemy import Table, Column, String, DateTime, func, JSON
from sqlalchemy.dialects.postgresql import UUID as PGUUID, JSONB
from sqlalchemy import select
from uuid import UUID
from .db import SessionLocal, engine, Base
from datetime import datetime


class VulnerabilityRecordTable(Base):
    __tablename__ = "vulnerability_records"


def init_sql_store():
    # Create a lightweight table for JSONB-stored vulnerability records
    # Use raw SQL to be concise; SQL schema file contains full relational tables.
    with engine.begin() as conn:
        conn.execute(
            """
            CREATE TABLE IF NOT EXISTS vulnerability_records (
                id UUID PRIMARY KEY,
                payload JSONB NOT NULL,
                recorded_at TIMESTAMPTZ NOT NULL DEFAULT now()
            );
            """
        )


class SQLVulnerabilityStore:
    def __init__(self):
        self.Session = SessionLocal

    def add(self, record):
        # record is a Pydantic model; convert to dict
        payload = record.model_dump() if hasattr(record, "model_dump") else record.dict()
        vid = str(record.vulnerability_id)
        stmt = f"INSERT INTO vulnerability_records (id, payload, recorded_at) VALUES ('{vid}', :payload, now())"
        with self.Session() as s:
            s.execute(stmt, {"payload": payload})
            s.commit()

    def list(self):
        with self.Session() as s:
            res = s.execute(select("id", "payload").select_from("vulnerability_records"))
            return [r[1] for r in res.fetchall()]

    def get(self, vulnerability_id: UUID):
        with self.Session() as s:
            r = s.execute(select("payload").select_from("vulnerability_records").where(f"id='{vulnerability_id}'")).fetchone()
            return r[0] if r else None

    def update(self, vulnerability_id: UUID, record):
        payload = record.model_dump() if hasattr(record, "model_dump") else record.dict()
        stmt = f"UPDATE vulnerability_records SET payload = :payload WHERE id = '{vulnerability_id}'"
        with self.Session() as s:
            s.execute(stmt, {"payload": payload})
            s.commit()
